import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

# Page config
st.set_page_config(
    page_title="Square Seller Insights",
    page_icon="ðŸ“Š",
    layout="wide"
)

# Custom CSS
st.markdown("""
    <style>
    .big-font {
        font-size:20px !important;
        font-weight: bold;
    }
    </style>
    """, unsafe_allow_html=True)

# Title
st.title("ðŸ“Š Square Seller Insights Dashboard")
st.markdown("*AI-powered analysis of 1,000+ seller reviews using GPT-4o-mini*")
st.markdown("---")

# Load data
@st.cache_data
def load_data():
    square = pd.read_csv("square_reviews_analyzed.csv")
    shopify = pd.read_csv("shopify_reviews_analyzed.csv")
    return square, shopify

square_df, shopify_df = load_data()

# Sidebar filters
st.sidebar.header("ðŸ” Filters")
rating_filter = st.sidebar.slider("Rating Range", 1, 5, (1, 5))

square_filtered = square_df[
    (square_df['rating'] >= rating_filter[0]) & 
    (square_df['rating'] <= rating_filter[1])
]
shopify_filtered = shopify_df[
    (shopify_df['rating'] >= rating_filter[0]) & 
    (shopify_df['rating'] <= rating_filter[1])
]

# Top metrics
col1, col2, col3, col4 = st.columns(4)

with col1:
    st.metric("Total Reviews", f"{len(square_filtered) + len(shopify_filtered):,}")
with col2:
    square_rating = square_filtered['rating'].mean()
    st.metric("Square Avg Rating", f"{square_rating:.2f}/5 â­")
with col3:
    shopify_rating = shopify_filtered['rating'].mean()
    delta = square_rating - shopify_rating
    st.metric("Shopify Avg Rating", f"{shopify_rating:.2f}/5 â­", delta=f"{delta:.2f} lower", delta_color="inverse")
with col4:
    square_churn = (square_filtered['is_churn_risk'].sum() / len(square_filtered) * 100)
    st.metric("Square Churn Risk", f"{square_churn:.1f}%")

st.markdown("---")

# Tabs
tab1, tab2, tab3, tab4, tab5 = st.tabs([
    "ðŸŽ¯ Key Findings", 
    "ðŸ“Š Deep Dive", 
    "ðŸ” Competitive Analysis", 
    "ðŸ’¡ Recommendations",
    "ðŸ“‹ About"
])

with tab1:
    st.header("Key Findings")
    st.success("**Finding #1:** Square maintains 3.08/5 rating vs Shopify's 2.17/5 - full point advantage")
    st.warning("**Finding #2:** 77% of Shopify sellers show churn risk vs 50.8% for Square")
    st.info("**Finding #3:** Support is #1 concern for both platforms")

with tab2:
    st.header("Square Analysis")
    
    col1, col2 = st.columns(2)
    with col1:
        sentiment_data = square_filtered['sentiment'].value_counts().reset_index()
        sentiment_data.columns = ['sentiment', 'count']
        fig = px.bar(sentiment_data, x='sentiment', y='count', title="Sentiment Distribution")
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        theme_data = square_filtered['theme'].value_counts().head(5).reset_index()
        theme_data.columns = ['theme', 'count']
        fig = px.bar(theme_data, x='theme', y='count', title="Top Themes")
        st.plotly_chart(fig, use_container_width=True)

with tab3:
    st.header("Square vs Shopify")
    comparison = pd.DataFrame({
        'Metric': ['Avg Rating', 'Churn Risk %'],
        'Square': [f"{square_filtered['rating'].mean():.2f}", f"{(square_filtered['is_churn_risk'].sum()/len(square_filtered)*100):.1f}%"],
        'Shopify': [f"{shopify_filtered['rating'].mean():.2f}", f"{(shopify_filtered['is_churn_risk'].sum()/len(shopify_filtered)*100):.1f}%"]
    })
    st.table(comparison)

with tab4:
    st.header("ðŸ’¡ Product Recommendations")
    st.subheader("ðŸŽ¯ #1: Target Frustrated Shopify Sellers")
    st.markdown("""
    **Data:** Shopify has 77% churn risk vs Square's 50.8%
    
    **Actions:**
    - Build Shopify-to-Square migration tools
    - Marketing: "Switch in 3 Steps"
    - Offer fee reduction for switchers
    """)
    
    st.subheader("ðŸ› ï¸ #2: Double Down on Support")
    st.markdown("""
    **Data:** Support is #1 complaint (183 Square, 154 Shopify mentions)
    
    **Actions:**
    - AI-powered support triage
    - Reduce response time 24h â†’ 2h
    - Expand weekend coverage
    """)
    
    st.subheader("ðŸ“ˆ #3: Convert Haters to Lovers")
    st.markdown("""
    **Data:** Square shows 43% very negative, 43% very positive
    
    **Actions:**
    - Interview very negative sellers
    - Segment-specific onboarding
    - Early warning system for at-risk sellers
    """)

with tab5:
    st.header("ðŸ“‹ About This Project")
    
    st.markdown("""
    This project demonstrates my ability to leverage AI tools as a force multiplier while 
    maintaining full ownership of product strategy and decision-making.
    """)
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("ðŸ§  What I Did")
        st.markdown("""
        **Strategic Decisions:**
        - Identified Square seller reviews as high-value data source
        - Chose Shopify as key competitive benchmark
        - Defined 6 analysis dimensions (sentiment, themes, churn, etc.)
        - Prioritized support optimization as #1 opportunity
        - Developed 3-tiered recommendation framework
        
        **Technical Execution:**
        - Built data collection pipeline (iTunes API)
        - Designed AI analysis prompts for GPT-4o-mini
        - Created classification schema for themes/sentiment
        - Developed interactive dashboard architecture
        - Synthesized insights into product recommendations
        
        **Product Thinking:**
        - Connected data insights to business strategy
        - Identified opportunity: 50% churn risk reduction potential
        - Proposed measurable success metrics
        - Created implementation roadmap
        """)
    
    with col2:
        st.subheader("ðŸ¤– How I Used AI")
        st.markdown("""
        **AI as a Tool, Not a Replacement:**
        - **GPT-4o-mini** for scale analysis (1,000 reviews in 30 mins vs weeks manually)
        - **Claude** for code assistance and debugging
        - **Prompt engineering** to extract structured insights
        
        **My Judgment Throughout:**
        - I designed the analysis framework
        - I validated AI outputs for accuracy
        - I interpreted findings through product lens
        - I made strategic recommendations
        - I built the dashboard and narrative
        
        **This is AI-native PM work:** using AI to move 10x faster while 
        maintaining full creative and strategic control.
        """)
    
    st.markdown("---")
    
    st.subheader("âš™ï¸ Technical Stack")
    
    tech_data = pd.DataFrame({
        'Component': ['Data Collection', 'AI Analysis', 'Dashboard', 'Deployment'],
        'Technology': ['iTunes API + Python', 'OpenAI GPT-4o-mini', 'Streamlit + Plotly', 'Streamlit Cloud'],
        'Why I Chose It': [
            'Free, reliable, 500+ reviews available',
            'Best price/performance for classification',
            'Fast iteration, beautiful results',
            'Free hosting, professional URL'
        ]
    })
    
    st.table(tech_data)
    
    st.markdown("---")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("Time Investment", "1 day")
    with col2:
        st.metric("Cost", "$1.00")
    with col3:
        st.metric("Reviews Analyzed", "1,000")
    
    st.success("""
    **Key Insight Discovered:** Shopify sellers show 50% higher churn risk (77% vs 51%) 
    and rate the platform nearly 1 full point lower than Square sellers. This represents 
    a significant market opportunity for Square to capture dissatisfied Shopify merchants.
    """)

st.caption("Built by Shreeya Rishi Kairamkonda | 1,000 reviews analyzed | February 2026")